<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>El Rinc√≥n de la Tati - Cat√°logo</title>

    <!-- Fuente -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #FFE8D9;
            font-family: 'Poppins', sans-serif;
        }

        /* ------------------- HEADER ------------------- */
        header {
            background: #B71C1C;
            padding: 25px 0 10px;
            color: white;
            text-align: center;
            font-size: 26px;
            font-weight: bold;
        }

        header small {
            display: block;
            font-size: 16px;
            margin-top: 4px;
        }

        /* ------------------- BOTONES DE CATEGOR√çA ------------------- */
        .categorias {
            text-align: center;
            margin: 15px auto 25px;
        }

        .btn-cat {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: white;
            border: 3px solid #f4b75f;
            padding: 12px 26px;
            border-radius: 30px;
            margin: 4px 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: 0.2s;
        }

        .btn-cat:hover,
        .btn-cat.active {
            background: #fbdcb1;
            transform: scale(1.05);
        }

        /* ------------------- PRODUCTOS ------------------- */
        .contenedor-productos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
            gap: 25px;
            padding: 10px 20px 60px;
            max-width: 1300px;
            margin: auto;
        }

        .tarjeta {
            background: white;
            border-radius: 20px;
            padding: 16px;
            border: 3px solid #f1c27d;
            box-shadow: 0 5px 18px rgba(0,0,0,0.1);
            transition: 0.25s;
            position: relative;
        }

        .tarjeta:hover {
            transform: translateY(-6px);
        }

        /* ------------------- IMAGENES OPTIMIZADAS ------------------- */
        .imagen-producto {
            width: 100%;
            height: 260px;
            background: #fafafa;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .imagen-producto img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* üî• Ajusta completamente sin cortar */
            aspect-ratio: 1/1;
        }

        /* ------------------- ETIQUETA AGOTADO ------------------- */
        .agotado-label {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%) rotate(-8deg);
            background: #e53935;
            color: white;
            padding: 7px 18px;
            font-size: 17px;
            font-weight: 700;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
            z-index: 10;
        }

        /* ------------------- DETALLES DEL PRODUCTO ------------------- */
        .nombre-producto {
            margin: 12px 0 4px;
            font-size: 17px;
            font-weight: 600;
            text-align: left;
        }

        .precio {
            font-size: 19px;
            font-weight: 700;
            color: #B71C1C;
        }

        .categoria-chip {
            background: #f4d699;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }

        /* ------------------- BOT√ìN VER DESCRIPCI√ìN ------------------- */
        .btn-descripcion {
            background: #fff6e8;
            border: 2px solid #f1c27d;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            margin: 8px 0 12px;
        }

        /* ------------------- CONTADOR CANTIDADES ------------------- */
        .contador {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            margin: 10px 0;
        }

        .btn-cantidad {
            background: #B71C1C;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            font-size: 22px;
            cursor: pointer;
        }

        /* ------------------- BOT√ìN ELEGIR ------------------- */
        .btn-elegir {
            width: 100%;
            background: #B71C1C;
            color: white;
            padding: 12px 0;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 15px;
        }

        /* ------------------- MENSAJE AGOTADO ABAJO ------------------- */
        .agotado-texto {
            text-align: center;
            color: #d32f2f;
            font-weight: 700;
            font-size: 15px;
            margin-top: 12px;
        }

        /* ------------------- CARRITO ------------------- */
        #carrito-btn {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: white; /* üî• Fondo blanco */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
        }

        #carrito-btn img {
            width: 28px;
            filter: brightness(0); /* üî• Icono negro */
        }

        /* Burbuja cantidades del carro */
        #carrito-contador {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #FFD700; /* Amarillo */
            color: #c62828; /* Rojo */
            font-size: 15px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
        }
    </style>
</head>

<body>

<header>
    üéÅ El Rinc√≥n de la Tati  
    <small>Cat√°logo de Productos</small>
</header>

<!-- CATEGOR√çAS -->
<div class="categorias">
    <span class="btn-cat active" data-cat="todos">üì¶ Ver Todo</span>
    <span class="btn-cat" data-cat="navidad">üéÑ Navidad</span>
    <span class="btn-cat" data-cat="tejido">üßµ Tejido</span>
    <span class="btn-cat" data-cat="hogar">üè† Hogar</span>
    <span class="btn-cat" data-cat="ni√±os">üë∂ Ni√±os</span>
    <span class="btn-cat" data-cat="mujer">üëó Mujer</span>
</div>

<div class="contenedor-productos" id="lista-productos"></div>

<!-- BOT√ìN CARRITO FLOTANTE -->
<div id="carrito-btn">
    <!-- Puedes cambiar esta imagen si quieres otro √≠cono -->
    <img src="https://cdn-icons-png.flaticon.com/512/891/891462.png" alt="Carrito">
    <span id="carrito-contador">0</span>
</div>

<!-- RESUMEN DEL CARRITO -->
<section id="resumen-carrito" style="
    max-width: 900px;
    margin: 40px auto 60px;
    padding: 20px 24px;
    background: white;
    border-radius: 18px;
    border: 3px solid #f1c27d;
    box-shadow: 0 5px 18px rgba(0,0,0,0.1);
    display: none;
">
    <h2 style="margin-top:0;">üß∫ Tu pedido</h2>
    <div id="detalle-carrito"></div>
    <p id="total-carrito" style="font-weight:700; font-size:18px; margin-top:18px;"></p>
    <a id="btn-whatsapp" target="_blank" style="
        display:inline-block;
        margin-top:10px;
        background:#25D366;
        color:white;
        padding:10px 18px;
        border-radius:14px;
        font-weight:600;
        text-decoration:none;
    ">
        üì≤ Enviar pedido por WhatsApp
    </a>
</section>

<!-- SUPABASE JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
  // ------------------- CONFIG SUPABASE -------------------
  const SUPABASE_URL = 'https://wazkoegfeuttutfoqfjt.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhemtvZWdmZXV0dHV0Zm9xZmp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTExNDUsImV4cCI6MjA3OTk2NzE0NX0.9DUTvS_tekHNPFZHCA_6XHIfQ9ize40xXKP54XZf84k';

  const { createClient } = supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ------------------- ESTADO GLOBAL -------------------
  const listaProductosEl = document.getElementById('lista-productos');
  const carritoBtn = document.getElementById('carrito-btn');
  const carritoContadorEl = document.getElementById('carrito-contador');
  const resumenCarritoEl = document.getElementById('resumen-carrito');
  const detalleCarritoEl = document.getElementById('detalle-carrito');
  const totalCarritoEl = document.getElementById('total-carrito');
  const btnWhatsapp = document.getElementById('btn-whatsapp');

  // carrito: id -> { producto, cantidad }
  const carrito = new Map();
  let productosCargados = [];

  // ------------------- CARGAR PRODUCTOS -------------------
  async function cargarProductos() {
    const { data, error } = await supabaseClient
      .from('productos')
      .select('*')
      .order('created_at', { ascending: true });

    if (error) {
      console.error('Error cargando productos', error);
      listaProductosEl.innerHTML = '<p>Error cargando productos üò¢</p>';
      return;
    }

    productosCargados = data || [];
    renderProductos('todos');
  }

  // ------------------- RENDER -------------------
  function renderProductos(categoria) {
    listaProductosEl.innerHTML = '';

    const filtrados = productosCargados.filter(p => {
      if (categoria === 'todos') return true;
      if (!p.categoria) return false;
      return p.categoria.toLowerCase() === categoria.toLowerCase();
    });

    if (filtrados.length === 0) {
      listaProductosEl.innerHTML = `
        <div style="
          grid-column: 1 / -1;
          background:#fff3cd;
          border-radius:16px;
          padding:20px;
          text-align:center;
          border:2px solid #ffe082;
        ">
          Por ahora no hay productos para esta categor√≠a todav√≠a. üò¢
        </div>`;
      return;
    }

    filtrados.forEach(prod => {
      const tarjeta = document.createElement('div');
      tarjeta.className = 'tarjeta';

      // Cinta de AGOTADO si corresponde
      if (prod.agotado) {
        const label = document.createElement('div');
        label.className = 'agotado-label';
        label.textContent = 'PRODUCTO AGOTADO';
        tarjeta.appendChild(label);
      }

      // Imagen
      const contImg = document.createElement('div');
      contImg.className = 'imagen-producto';

      const img = document.createElement('img');
      img.src = prod.imagen_url || '';
      img.alt = prod.nombre || 'Producto';

      contImg.appendChild(img);
      tarjeta.appendChild(contImg);

      // Nombre
      const nombre = document.createElement('div');
      nombre.className = 'nombre-producto';
      nombre.textContent = prod.nombre || 'Producto sin nombre';
      tarjeta.appendChild(nombre);

      // Precio + chip categor√≠a
      const precioLinea = document.createElement('div');
      const precioSpan = document.createElement('span');
      precioSpan.className = 'precio';
      precioSpan.textContent = `$${formatearPrecio(prod.precio || 0)} CLP`;
      precioLinea.appendChild(precioSpan);

      if (prod.categoria) {
        const catChip = document.createElement('span');
        catChip.className = 'categoria-chip';
        catChip.textContent = prod.categoria.toLowerCase();
        precioLinea.appendChild(catChip);
      }

      tarjeta.appendChild(precioLinea);

      // Bot√≥n "Ver descripci√≥n"
      const btnDesc = document.createElement('button');
      btnDesc.className = 'btn-descripcion';
      btnDesc.textContent = 'üìÑ Ver descripci√≥n';
      btnDesc.addEventListener('click', () => {
        alert(prod.descripcion || 'Sin descripci√≥n.');
      });
      tarjeta.appendChild(btnDesc);

      if (prod.agotado) {
        // SOLO MENSAJE DE AGOTADO ABAJO
        const agotadoTxt = document.createElement('div');
        agotadoTxt.className = 'agotado-texto';
        agotadoTxt.textContent = 'Este producto est√° agotado üò¢';
        tarjeta.appendChild(agotadoTxt);
      } else {
        // ------------------- CONTADOR + ELEGIR -------------------
        const contador = document.createElement('div');
        contador.className = 'contador';
        contador.style.display = 'none';  // üî• aparece reci√©n al elegir

        const btnMenos = document.createElement('button');
        btnMenos.className = 'btn-cantidad';
        btnMenos.textContent = '‚àí';

        const spanCantidad = document.createElement('span');
        spanCantidad.textContent = '1';

        const btnMas = document.createElement('button');
        btnMas.className = 'btn-cantidad';
        btnMas.textContent = '+';

        contador.appendChild(btnMenos);
        contador.appendChild(spanCantidad);
        contador.appendChild(btnMas);

        tarjeta.appendChild(contador);

        const btnElegir = document.createElement('button');
        btnElegir.className = 'btn-elegir';
        btnElegir.textContent = 'Elegir';
        tarjeta.appendChild(btnElegir);

        let cantidad = 0;

        function setCantidad(n) {
          cantidad = Math.max(0, n);
          if (cantidad === 0) {
            contador.style.display = 'none';
            btnElegir.textContent = 'Elegir';
            carrito.delete(prod.id);
          } else {
            spanCantidad.textContent = cantidad;
            contador.style.display = 'flex';
            btnElegir.textContent = 'Actualizar';
            carrito.set(prod.id, {
              producto: prod,
              cantidad
            });
          }
          actualizarCarritoUI();
        }

        btnElegir.addEventListener('click', () => {
          if (cantidad === 0) {
            // Primer click ‚Üí arranca en 1
            setCantidad(1);
          } else {
            // Ya tiene cantidad, simplemente actualiza (no hace nada extra)
            setCantidad(cantidad);
          }
        });

        btnMas.addEventListener('click', () => setCantidad(cantidad + 1));
        btnMenos.addEventListener('click', () => setCantidad(cantidad - 1));
      }

      listaProductosEl.appendChild(tarjeta);
    });
  }

  // ------------------- CARRITO UI -------------------
  function actualizarCarritoUI() {
    let totalItems = 0;
    let totalPrecio = 0;
    detalleCarritoEl.innerHTML = '';

    carrito.forEach(({ producto, cantidad }) => {
      totalItems += cantidad;
      totalPrecio += cantidad * (producto.precio || 0);

      const linea = document.createElement('div');
      linea.textContent = `${cantidad} x ${producto.nombre} ‚Äî $${formatearPrecio(producto.precio || 0)} CLP`;
      detalleCarritoEl.appendChild(linea);
    });

    carritoContadorEl.textContent = totalItems;
    if (totalItems === 0) {
      carritoContadorEl.style.display = 'none';
      resumenCarritoEl.style.display = 'none';
    } else {
      carritoContadorEl.style.display = 'block';
      totalCarritoEl.textContent = `Total a pagar: $${formatearPrecio(totalPrecio)} CLP`;
    }

    actualizarWhatsapp(totalItems, totalPrecio);
  }

  function actualizarWhatsapp(totalItems, totalPrecio) {
    if (totalItems === 0) {
      btnWhatsapp.href = '#';
      return;
    }
    let mensaje = 'Hola, quiero hacer el siguiente pedido:%0A';
    carrito.forEach(({ producto, cantidad }) => {
      mensaje += `- ${cantidad} x ${producto.nombre} - $${formatearPrecio(producto.precio || 0)} CLP%0A`;
    });
    mensaje += `%0ATotal: $${formatearPrecio(totalPrecio)} CLP`;

    // ‚ö†Ô∏è CAMBIA ESTE N√öMERO POR EL DE TU WHATSAPP
    const telefono = '56900000000';
    const url = `https://wa.me/${telefono}?text=${mensaje}`;
    btnWhatsapp.href = url;
  }

  // ------------------- UTIL -------------------
  function formatearPrecio(num) {
    return Number(num || 0).toLocaleString('es-CL');
  }

  // ------------------- EVENTOS CATEGOR√çAS -------------------
  document.querySelectorAll('.btn-cat').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.btn-cat').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderProductos(btn.dataset.cat);
    });
  });

  // ------------------- VER / OCULTAR RESUMEN CARRITO -------------------
  carritoBtn.addEventListener('click', () => {
    if (carrito.size === 0) return;
    const visible = resumenCarritoEl.style.display === 'block';
    resumenCarritoEl.style.display = visible ? 'none' : 'block';
    if (!visible) {
      resumenCarritoEl.scrollIntoView({ behavior: 'smooth' });
    }
  });

  // ------------------- INICIO -------------------
  cargarProductos();
</script>

</body>
</html>
